version: '3.8'

services:
  mqtt-broker:
    build: ./mqtt-broker
    container_name: mqtt-broker
    ports:
      - "1883:1883"
    volumes:
      - mqtt-data:/mosquitto/data
    networks:
      - mqtt-network
    restart: unless-stopped

  mqtt-test-client:
    build: 
      context: .
      dockerfile: ./mqtt-test-client/Dockerfile
    container_name: mqtt-test-client
    environment:
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=1883
      - MQTT_TOPIC=sensor/data
      - TEST_DATA_DIR=/app/test-data
      - PUBLISH_INTERVAL=${PUBLISH_INTERVAL:-5}
    volumes:
      - ./test-data/bird-events:/app/test-data:ro
    depends_on:
      - mqtt-broker
    networks:
      - mqtt-network
    restart: unless-stopped

  mqtt-proxy:
    build: ./mqtt-proxy
    container_name: mqtt-proxy
    environment:
      # Local MQTT broker configuration
      - LOCAL_MQTT_BROKER=mqtt-broker
      - LOCAL_MQTT_PORT=1883
      - LOCAL_MQTT_TOPIC=sensor/data
      # Azure Event Grid MQTT Broker configuration
      - EVENTGRID_MQTT_HOSTNAME=${EVENTGRID_MQTT_HOSTNAME:-}
      - EVENTGRID_MQTT_PORT=${EVENTGRID_MQTT_PORT:-8883}
      - EVENTGRID_MQTT_TOPIC=${EVENTGRID_MQTT_TOPIC:-sensor/data}
      # Authentication settings (SAS token)
      - MQTT_CLIENT_ID=${MQTT_CLIENT_ID:-mqtt-proxy}
      - MQTT_USERNAME=${MQTT_USERNAME:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      # Certificate-based authentication (optional)
      - MQTT_CERT_FILE=${MQTT_CERT_FILE:-}
      - MQTT_KEY_FILE=${MQTT_KEY_FILE:-}
      - MQTT_CA_CERTS=${MQTT_CA_CERTS:-}
    volumes:
      # Mount certificates directory if using certificate auth
      - ${CERTS_DIR:-./certs}:/app/certs:ro
    depends_on:
      - mqtt-broker
    networks:
      - mqtt-network
    restart: unless-stopped

volumes:
  mqtt-data:

networks:
  mqtt-network:
    driver: bridge
